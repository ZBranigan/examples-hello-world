<!DOCTYPE html>
<html lang="en" data-theme="cyberpunk">
<head>
  <meta charset="UTF-8" />
  <title>‚ö° CipherStore ‚Äì Decentralised Crypto-Anarchist App Hub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5/dist/cyberpunk.css" rel="stylesheet" />

  <!-- Gun.js P2P database -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<!-- 1.  Reown AppKit + Universal Provider  -->
<script type="module">
  import { createAppKit } from 'https://cdn.jsdelivr.net/npm/@reown/appkit@1.0.0/dist/appkit.js';
  import { WagmiAdapter } from 'https://cdn.jsdelivr.net/npm/@reown/appkit-adapter-wagmi@1.0.0/dist/appkit-adapter-wagmi.js';
  import { mainnet } from 'https://cdn.jsdelivr.net/npm/viem@2.9.0/chains';

  // 1-a.  Wagmi adapter (handles ethers/viem transparently)
  const wagmiAdapter = new WagmiAdapter({
    chains: [mainnet],
    projectId: 'YOUR_WC_PROJECT_ID', // ‚Üê same free ID from cloud.walletconnect.com
  });

  // 1-b.  Create the modal
  const modal = createAppKit({
    adapters: [wagmiAdapter],
    chains: [mainnet],
    projectId: 'YOUR_WC_PROJECT_ID',
    // optional theming
    themeMode: 'dark',
    themeVariables: {
      '--w3m-color-mix': '#00ffaa',
      '--w3m-color-mix-strength': 30
    }
  });

  // 1-c.  Export a minimal ethers signer-like object so the rest of the
  //       prototype still works without changes.
  window.wcProvider = {
    async connect() {
      await modal.open();
      return modal.getWalletProvider(); // EIP-1193 provider
    },
    async request({ method, params }) {
      const provider = modal.getWalletProvider();
      return provider.request({ method, params });
    }
  };
</script>
  <!-- t we IPFS via web3.storage (client-side) -->
  <script src="https://unpkg.com/web3.storage@4.5.5/dist/bundle.esm.min.js" type="module"></script>
</head>

<body class="min-h-screen bg-base-100 text-base-content">
  <!-- ==================  HEADER  ================== -->
  <header class="navbar sticky top-0 z-50 backdrop-blur bg-base-100/80 border-b border-primary">
    <div class="flex-1 px-2 lg:flex-none">
      <a class="text-lg font-bold select-none">‚ö° CipherStore</a>
    </div>
    <div class="flex justify-end flex-1 px-2">
      <button id="connectWallet" class="btn btn-primary btn-sm">Connect Wallet</button>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 space-y-10">

    <!-- ==============  PUBLISH CARD  ============== -->
    <section class="card bg-base-200 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Publish Build</h2>
        <p class="text-sm opacity-70">Drop your signed .apk / .zip below.  Metadata + IPFS hash will be pinned and registered on-chain.</p>

        <form id="publishForm" class="space-y-4 mt-4">
          <input required name="appName" type="text" placeholder="App name" class="input input-bordered w-full" />
          <input required name="version" type="text" placeholder="Version" class="input input-bordered w-full" />
          <textarea required name="description" class="textarea textarea-bordered w-full" placeholder="Description"></textarea>

          <label class="block">
            <span class="label-text">Build artefact</span>
            <input required name="artefact" type="file" class="file-input file-input-bordered w-full" />
          </label>

          <button class="btn btn-accent w-full">Publish & Register</button>
        </form>
      </div>
    </section>

    <!-- ==============  APP LIST  ============== -->
    <section>
      <h2 class="text-2xl font-bold mb-4">Discover</h2>
      <div id="appGrid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
    </section>

  </main>

  <!-- ==================  FOOTER  ================== -->
  <footer class="p-8 text-center text-xs opacity-50">
    Built with ‚ò†Ô∏è for the decentralised future.
  </footer>

  <!-- ==================  SCRIPT  ================== -->
  <script type="module">
    /* ---------- 0.  HELPERS  ---------- */
    const $ = q => document.querySelector(q);
    const gun = Gun(); // peers via public relays by default
    const registry = gun.get('cipherstore/apps');

    const web3storage = new Web3Storage({ token: 'YOUR_WEB3_STORAGE_TOKEN' }); // free 1 GB

    let signer, address;

    /* ---------- 1.  WALLET ---------- */
    $('#connectWallet').onclick = async () => {
      await window.wcProvider.connect();
      signer = window.wcProvider;
      address = await signer.request({ method: 'eth_accounts' }).then(a => a[0]);
      $('#connectWallet').textContent = `${address.slice(0,6)}‚Ä¶${address.slice(-4)}`;
    };

    /* ---------- 2.  PUBLISH ---------- */
    $('#publishForm').onsubmit = async e => {
      e.preventDefault();
      if (!signer) return alert('Connect wallet first');

      const data = Object.fromEntries(new FormData(e.target));
      const file = data.artefact;
      const cid = await web3storage.put([file], { wrapWithDirectory: false });

      const meta = {
        name: data.appName,
        version: data.version,
        description: data.description,
        cid,
        publisher: address,
        ts: Date.now()
      };

      // save to Gun
      const key = `${meta.name.toLowerCase().replace(/\s+/g,'-')}-v${meta.version}`;
      registry.get(key).put(meta);

      // optional on-chain registry (see Solidity stub below)
      await registerOnChain(key, cid);

      e.target.reset();
      alert('Published üéÜ');
      renderApps();
    };

    /* ---------- 3.  RENDER  ---------- */
    async function renderApps() {
      $('#appGrid').innerHTML = '';
      registry.map().once(meta => {
        if (!meta || !meta.cid) return;
        const card = document.createElement('div');
        card.className = 'card bg-base-200 shadow';
        card.innerHTML = `
          <div class="card-body">
            <h3 class="card-title">${meta.name} <span class="badge badge-outline">v${meta.version}</span></h3>
            <p class="text-sm">${meta.description}</p>
            <div class="card-actions justify-between items-center mt-4">
              <a class="btn btn-sm btn-primary" href="https://w3s.link/ipfs/${meta.cid}" target="_blank">Download</a>
              <span class="text-xs opacity-60">by ${meta.publisher.slice(0,6)}‚Ä¶</span>
            </div>
            <div class="text-xs opacity-70 mt-2">Reviews: <span class="review-count">0</span></div>
          </div>`;
        $('#appGrid').appendChild(card);

        // load reviews
        gun.get(`cipherstore/reviews/${meta.name}`).map().once(r => {
          if (!r) return;
          card.querySelector('.review-count').textContent =
            parseInt(card.querySelector('.review-count').textContent) + 1;
        });
      });
    }

    /* ---------- 4.  ON-CHAIN REGISTRY (optional) ---------- */
    async function registerOnChain(key, cid) {
      const abi = [
        "function register(string memory key, string memory cid) external"
      ];
      const registryAddress = "0x...yourDeployedContract...";
      const ethers = await import("https://cdn.skypack.dev/ethers");
      const contract = new ethers.Contract(registryAddress, abi, signer);
      return contract.register(key, cid);
    }

    renderApps();
  </script>

  <!--  
  ----------  Solidity stub  ----------
  SPDX-License-Identifier: MIT
  pragma solidity ^0.8.0;

  contract CipherRegistry {
      mapping(string => string) public cidOf; // key -> IPFS hash
      function register(string calldata key, string calldata cid) external {
          cidOf[key] = cid;
      }
  }
  -->
</body>
</html>
